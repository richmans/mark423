mark423Styles = '<style>' + 
"div#mark423-player {" + 
"line-height: 1;" + 
"}" + 
"" + 
"div#mark423-playlist {" + 
"font: 14px arial;" + 
"}" + 
"div#mark423-player div.jp-progress{" + 
"height:13px;" + 
"cursor:pointer;" + 
"border:1px solid gray;" + 
"overflow:hidden;" + 
"-moz-border-radius: 6px;" + 
"-webkit-border-radius: 6px;" + 
"-khtml-border-radius: 6px;" + 
"border-radius: 6px;" + 
"margin-top: 15px;" + 
"" + 
"}" + 
"" + 
"div#mark423-player div.jp-seek-bar{background-color:#CCCCCC;}" + 
"div#mark423-player div.jp-play-bar{background-color:#DD4B39;}" + 
"" + 
"div#mark423-player div.jp-play-pause {" + 
"width:70px;" + 
"height:70px;" + 
"background-color:#f5f5f5;" + 
"border:1px solid #e5e5e5;" + 
"-moz-border-radius: 35px;" + 
"-webkit-border-radius: 35px;" + 
"-khtml-border-radius: 35px;" + 
"border-radius: 35px;" + 
"text-align:center;" + 
"vertical-align:middle;" + 
"float:left;" + 
"margin-top:10px;" + 
"}" + 
"svg {" + 
"width: 60%;" + 
"height: 60%" + 
"}" + 
"" + 
"div#mark423-player div.jp-play-pause a {" + 
"display:block;" + 
"width:100%;" + 
"height:100%;" + 
"color:#DD4B39;" + 
"text-decoration:none;" + 
"speak: none;" + 
"padding-top: 15px;" + 
"" + 
"}" + 
"" + 
"div#mark423-player div.jp-volume-controls{" + 
"height:13px;" + 
"float:right;" + 
"}" + 
"" + 
"div#mark423-player div.jp-volume-bar-value{" + 
"background-color:#DD4B39;" + 
"}" + 
"" + 
"div#mark423-player div.jp-volume-bar{" + 
"display:inline-block;" + 
"width:100px;" + 
"height:13px;" + 
"cursor:pointer;" + 
"border:1px solid gray;" + 
"overflow:hidden;" + 
"-moz-border-radius: 6px;" + 
"-webkit-border-radius: 6px;" + 
"-khtml-border-radius: 6px;" + 
"border-radius: 6px;" + 
"vertical-align:top;" + 
"margin-top: 7px;" + 
"" + 
"}" + 
"" + 
"div#mark423-player div.jp-mute, div#mark423-player div.jp-unmute {" + 
"display:inline;" + 
"width:50px;" + 
"margin-left:20px;" + 
"margin-right:10px;" + 
"cursor:pointer;" + 
"}" + 
"" + 
"" + 
"div#mark423-player div#mark423-player div.jp-unmute svg {" + 
"fill: #DD4B39;" + 
"}" + 
"" + 
"" + 
"div#mark423-player div.jp-eject {" + 
"float:right;" + 
"margin-top:43px;" + 
"text-align:center;" + 
"padding-top:13px;" + 
"width:50px;" + 
"height:37px;" + 
"-moz-border-radius: 25px;" + 
"-webkit-border-radius: 25px;" + 
"-khtml-border-radius: 25px;" + 
"border-radius: 25px;" + 
"background-color:#f5f5f5;" + 
"font-size:21px;" + 
"cursor:pointer;" + 
"}" + 
"" + 
"div#mark423-player div.jp-eject a{" + 
"text-decoration: none;" + 
"color:#DD4B39;" + 
"" + 
"}" + 
"" + 
"div#mark423-player div.jp-play-pause a.jp-play{ padding-left: 5px; }" + 
"div#mark423-player div.jp-play-pause a.jp-pause{ padding-left: 2px; }" + 
"div#mark423-player div.jp-display {" + 
"height: 65px;" + 
"margin-left:80px;" + 
"padding: 10px 15px 15px 15px;" + 
"background-color:#f5f5f5;" + 
"border:1px solid #e5e5e5;" + 
"" + 
"margin-bottom:9px;" + 
"-moz-border-radius: 6px;" + 
"-webkit-border-radius: 6px;" + 
"-khtml-border-radius: 6px;" + 
"border-radius: 6px;" + 
"margin-right: 65px;" + 
"}" + 
"" + 
"div#mark423-player div.jp-display div.jp-current-time {" + 
"font-size:25px;" + 
"text-align: center;" + 
"font-weight:900;" + 
"letter-spacing: 3px;" + 
"font-family: Arial;" + 
"color: #DD4B39;" + 
"margin-bottom:10px;" + 
"}" + 
"" + 
"div#mark423-player div.jp-display div.jp-current-speaker,div#mark423-player div.jp-display div.jp-current-theme {" + 
"font-size:14px;" + 
"height:17px;" + 
"overflow:hidden;" + 
"" + 
"}" + 
"" + 
"div#mark423-player div.jp-display span.label {" + 
"width:60px;" + 
"display:inline-block;" + 
"}" + 
"" + 
"div#mark423-playlist {" + 
"margin-top:20px;" + 
"padding:15px;" + 
"background-color:#f5f5f5;" + 
"border:1px solid #e5e5e5;" + 
"" + 
"margin-bottom:9px;" + 
"-moz-border-radius: 6px;" + 
"-webkit-border-radius: 6px;" + 
"-khtml-border-radius: 6px;" + 
"border-radius: 6px;" + 
"}" + 
"" + 
"div#mark423-playlist a{" + 
"display:block;" + 
"color:#555;" + 
"padding:5px;" + 
"text-decoration: none;" + 
"margin-bottom:9px;" + 
"-moz-border-radius: 6px;" + 
"-webkit-border-radius: 6px;" + 
"-khtml-border-radius: 6px;" + 
"cursor:pointer;" + 
"}" + 
"div#mark423-playlist a:hover{" + 
"color:#DD4B39;" + 
"}" + 
"" + 
"div#mark423-playlist a.playing {" + 
"background-color:#CCC;" + 
"color:#333;" + 
"}" + 
"" + 
".shadow {" + 
"-moz-box-shadow:    2px 2px 3px #aaa;" + 
"-webkit-box-shadow: 2px 2px 3px #aaa;" + 
"box-shadow:         2px 2px 3px #aaa;" + 
"}" + 
"" + 
"div.jp-no-solution a{" + 
"color:#DD4B39;" + 
"}" + 
"" + 
"div.jp-no-solution {" + 
"background-color:#e5e5e5;" + 
"color:#DD4B39;" + 
"position:absolute;" + 
"height:200px;" + 
"width:100%;" + 
"font-size:20px;" + 
"text-align:center;" + 
"padding-top:50px;" + 
"font-weight:900;" + 
"}" + 
"</style>";
mark423Interface = '' + 
"" + 
"<div id=\"mark423-player-audio\">" + 
"</div>" + 
"<div id=\"mark423-player\" style='width: 100%'>" + 
"<div class='jp-controls'>" + 
"<div class='jp-play-pause shadow'>" + 
"<a href=\"#\" class=\"jp-play\">" + 
"<svg id=\"Layer_1\" data-name=\"Layer 1\" xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 512 512\"><path d=\"M60.54,512c-17.06,0-30.43-13.86-30.43-31.56V31.55C30.12,13.86,43.48,0,60.55,0A32.94,32.94,0,0,1,77,4.52L465.7,229c10.13,5.85,16.18,16,16.18,27s-6,21.2-16.18,27L77,507.48A32.92,32.92,0,0,1,60.55,512Z\"/></svg>" + 
"</a>" + 
"<a href=\"#\" class=\"jp-pause\" style='display:none'><svg id=\"Layer_1\" data-name=\"Layer 1\" xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 512 512\"><path d=\"M395,512a73.14,73.14,0,0,1-73.14-73.14V73.14a73.14,73.14,0,1,1,146.29,0V438.86A73.14,73.14,0,0,1,395,512Z\" fill=\"#434040\"/><path d=\"M117,512a73.14,73.14,0,0,1-73.14-73.14V73.14a73.14,73.14,0,1,1,146.29,0V438.86A73.14,73.14,0,0,1,117,512Z\"/></svg></a>" + 
"</div>" + 
"<div class='jp-eject shadow'>" + 
"<a href='#'>" + 
"<svg id=\"Layer_1\" data-name=\"Layer 1\" xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 512 512\"><path d=\"M26.36,459a53,53,0,0,0,53,53H432.63a53,53,0,0,0,0-106H79.37A53,53,0,0,0,26.36,459Z\"/><path d=\"M473.79,316.06c0,14.52-11.8,25.89-26.85,25.89H65.05c-15.05,0-26.84-11.37-26.84-25.89a28,28,0,0,1,3.84-14L233,13.77C238,5.14,246.57,0,256,0s18,5.14,23,13.77L469.95,302.1a28,28,0,0,1,3.84,14Z\"/></svg>" + 
"</a>" + 
"</div>" + 
"<div class='jp-display shadow'>" + 
"<div class='jp-current-time'></div>" + 
"<div class='jp-current-speaker'><span class='label speaker-label'>Speaker: </span><span id='mark423-player-speaker'>Loading...</span></div>" + 
"<div class='jp-current-theme'><span class='label theme-label'>Theme: </span></span><span id='mark423-player-theme'>Loading...</span></div>" + 
"</div>" + 
"</div>" + 
"" + 
"<div class='jp-volume-controls'>" + 
"<div class='jp-mute'><svg viewBox=\"0 0 307 307\" version=\"1.1\">    <g>        <path d=\"M100,85.499C62.766,85.683 47.261,84.75 47.261,84.75C31.333,89.628 19.747,104.438 19.747,121.968L19.747,192.036C19.747,213.535 37.177,230.96 58.671,230.96L99.374,230.96L211.462,304.572C222.435,310.634 237.245,299.478 245.052,284.841L245.386,285.176L245.407,284.164C245.551,283.884 245.694,283.6 245.834,283.316L245.432,282.914L250.386,41.816C250.386,20.316 230.922,-9.437 211.462,2.892L100,85.499Z\" style=\"fill-rule:nonzero;\"/>    </g></svg></div>" + 
"<div class='jp-unmute'><svg version=\"1.1\" id=\"Capa_1\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" x=\"0px\" y=\"0px\" width=\"306.257px\" height=\"306.257px\" viewBox=\"0 0 306.257 306.257\">	<path d=\"M19.747,121.968v70.068c0,21.499,17.43,38.924,38.924,38.924h40.703l112.088,73.612		c11.351,6.271,26.808-5.883,34.372-21.256L47.261,84.75C31.333,89.628,19.747,104.438,19.747,121.968z\"/>	<path d=\"M250.386,41.816c0-21.5-19.464-51.253-38.924-38.924L108.71,76.499l141.676,141.677V41.816z\"/>	<path d=\"M55.463,83.202l193.146,193.145l18.88,18.874c3.459,3.469,8.005,5.204,12.547,5.204c4.541,0,9.087-1.735,12.552-5.204		c6.934-6.929,6.934-18.17,0-25.104l-42.197-42.197L103.037,80.566L38.771,16.314c-3.461-3.469-8.005-5.204-12.549-5.204		c-4.544,0-9.085,1.735-12.552,5.204c-6.937,6.928-6.937,18.17,0,25.101L55.463,83.202z\"/></svg></div>" + 
"<div class='jp-volume-bar shadow'>" + 
"<div class='jp-volume-bar-value'>&nbsp;</div>" + 
"</div>" + 
"</div>" + 
"<div class='jp-progress shadow'>" + 
"<div class='jp-seek-bar'>" + 
"<div class='jp-play-bar'>&nbsp;</div>" + 
"</div>" + 
"</div>" + 
"" + 
"" + 
"</div>" + 
"<div id='mark423-playlist' class='shadow'>" + 
"</div>" + 
"";
var mark423Playlist = new Array();
var mark423Options = {};
var mark423Ready = false;
var mark423Language = 'en';
var mark423PrevVolume = 0.8

var mark423Translation = {
  'en': {
    'download alert': 'To download this audio file, please right-click this button and select \'save target as\'',
    'speaker': 'Speaker: ',
    'theme': 'Theme: ',
    'no recordings': "There are no recordings available"
  },
  'nl': {
    'download alert': 'Om deze opname te downloaden kunt u rechts-clicken op deze knop en dan kiezen voor \'Link opslaan als\'',
    'speaker': 'Spreker: ',
    'theme': 'Thema: ',
    'no recordings': "Er zijn nog geen opnamen beschikbaar."
  },
  'de': {
    'download alert': 'Zum downloaden klicken Sie mit der rechten Maustaste und w√§hlen Sie \'Ziel speichern unter\'',
    'speaker': 'Sprecher: ',
    'theme': 'Thema: ',
    'no recordings': "There are no recordings available"
  }
}
if(!window.console) {
  var console = { log: function (logMsg) { } };
}

function m4t(input) {
  if(!mark423Translation[mark423Language][input] || typeof mark423Translation[mark423Language][input] === "undefined") {
    return input;
  } else {
    return mark423Translation[mark423Language][input];
  }
}

function getElementByNodeName(parentNode, nodeName) {   
    var colonIndex = nodeName.indexOf(":");
    var tag = nodeName.substr(colonIndex + 1);
    var nodes = parentNode.getElementsByTagNameNS("*", tag);
    for (var i = 0; i < nodes.length; i++) {
        if (nodes[i].nodeName == nodeName) return nodes[i]
    }
    return undefined;
}

function Mark423Recording(speaker, theme, date, url, file_type){
  this.speaker = speaker;
  this.theme = theme;
  this.url = url;
  this.date = date
  this.file_type = file_type;
}

function mark423_format_date(date){
  var d = date.getDate();
  var m = date.getMonth() + 1;
  var y = date.getFullYear();
  return '' + (d <= 9 ? '0' + d : d) + '-' + (m<=9 ? '0' + m : m) + '-' + y;
}

function mark423_install_player(){
  audio_tag = document.createElement('audio');
  audio_tag.id = "mark423-audio"
  audio_tag.preload = false;
  audio_tag.ontimeupdate = mark423_update_progress
  document.querySelector('div#mark423-player-audio').appendChild(audio_tag)
  
  console.log("The player is ready for action.");
  mark423Ready = true;
 
  document.querySelector('div#mark423-player div.jp-eject a').addEventListener("click", function(e) {
    //alert(m4t('download alert'));
    return false;
  })
  
  document.querySelector('a.jp-play').addEventListener("click", mark423_play)
  document.querySelector('a.jp-pause').addEventListener("click", mark423_pause)
  document.querySelector('div.jp-mute').addEventListener("click", mark423_mute)
  document.querySelector('div.jp-unmute').addEventListener("click", mark423_unmute)  
  document.querySelector('div.jp-progress').addEventListener('click', mark423_skip)
  document.querySelector('div.jp-volume-bar').addEventListener('click', mark423_volume)
  mark423_set_volume(0.8)
}

function mark423_skip(e) {
  audio_tag = document.querySelector("audio#mark423-audio");
  let percent = (e.layerX / this.offsetWidth ) 
  let new_time = audio_tag.duration * percent
  audio_tag.currentTime = new_time;
}

function mark423_play() {
  document.querySelector("audio#mark423-audio").play()
  document.querySelector("a.jp-play").style.display = 'none'
  document.querySelector("a.jp-pause").style.display = 'inline-block'
  
}


function mark423_pause() {
  document.querySelector("audio#mark423-audio").pause()
  document.querySelector("a.jp-play").style.display = 'inline-block'
  document.querySelector("a.jp-pause").style.display = 'none'
  
}

function mark423_volume(e) {
  let x = e.clientX - e.currentTarget.offsetLeft; 
  let percent = x / this.offsetWidth
  mark423_set_volume(percent)
}

function mark423_set_volume(vol) {
  document.querySelector("audio#mark423-audio").volume = vol
  document.querySelector("div.jp-volume-bar-value").style.width = (vol * 100) + "%"
  if (vol == 0) {
    document.querySelector("div.jp-mute").style.display = 'none';
    document.querySelector("div.jp-unmute").style.display = 'inline-block';
    
  } else {
    document.querySelector("div.jp-mute").style.display = 'inline-block';
    document.querySelector("div.jp-unmute").style.display = 'none';
    
  }
}

function mark423_mute() {
  mark423PrevVolume = document.querySelector("audio#mark423-audio").volume
  mark423_set_volume(0)
}

function mark423_unmute() {
  mark423_set_volume(mark423PrevVolume)
}

function mark423_update_progress() {
  let audio_tag = document.querySelector("audio#mark423-audio");
  let percent = 0
  if (audio_tag.duration > 0 ) {
    percent = (audio_tag.currentTime / audio_tag.duration) * 100
  }
  if (audio_tag.currentTime == audio_tag.duration) {
    mark423_playback_done()
  }
  document.querySelector("div.jp-play-bar").style.width = percent + "%";
}

function mark423_playback_done() {
  mark423_pause()
  audio_tag.currentTime = 0;
}

function mark423_load_podcast(){
 if (typeof mark423Podcast === 'undefined' || mark423Ready == false){
    if(mark423Ready == false) console.log("waiting for player...");
    if (typeof mark423Podcast === 'undefined') console.log("Waiting for podcast...");
    setTimeout('mark423_load_podcast()', 100);
    return;
  }
  console.log("All files loaded, proceeding with initialize");
    // fetch and parse podcast xml
  mark423Playlist = new Array();
  counter = 0;
  mark423Language = mark423Podcast['language'];
  mark423Podcast['items'].forEach(function(item, index) {
    // fix for IE, which takes the comma at the end of the podcast js
    // as an empty element
    if (typeof item === 'undefined') return false;
    if (counter >= mark423Options['count']) return false;
    url = item["url"];
    theme = item['title'];
    speaker = item["speaker"];
    str_date = item['date'];
    file_type = item['type'];
    parsed_date = new Date(str_date);
    rendered_date = mark423_format_date(parsed_date);
    recording = new Mark423Recording(speaker, theme, rendered_date, url, file_type);
    mark423Playlist.push(recording);
    counter += 1;
    
  } );
  console.log("Filling playlist");
  // render playlist
  document.querySelector('div#mark423-playlist').innerHTML = "";
  counter = 0;
  mark423Playlist.forEach(function(recording){
    new_link = document.createElement('a');
    new_link.id = 'playlist-item-' + counter;
    if(recording.file_type == 'application/pdf') {
      new_link.href = recording.url;
      new_link.target = '_blank';
    }
    new_link.classList.add('playlist-item');
    new_link.innerHTML = recording.date  + ' - ' + recording.speaker + ' - ' + recording.theme;
    document.querySelector('div#mark423-playlist').appendChild(new_link);
    counter += 1;
  })

  // Install click handler for playlist items
  document.querySelectorAll('div#mark423-playlist a').forEach(function(item) {
    item.addEventListener("click", function(e) {
      element_id = this.id;
      item_id = element_id.split('-')[2];
      if(mark423Playlist[item_id].file_type == 'application/pdf'){
        return true;
      } else {
        mark423_switch_item(item_id);
        return false;
      }
    })
  });
  if (mark423Playlist.length> 0){
    mark423_switch_item(0);
  }else{
    console.log("No playlist items")
    document.querySelector('div#mark423-player span#mark423-player-speaker').innerHTML = m4t("no recordings");
    document.querySelector('div#mark423-player span#mark423-player-theme').innerHTML = "";
 
  }
  mark423_update_colors(mark423Options);
  mark423_apply_translations()
  console.log("Mark423 initialization ready");
  
}

function mark423_switch_item(item_id){
  let curItem = document.querySelector('div#mark423-playlist a.playing')
  if (curItem) {
    curItem.classList.remove('playing');
  }
  document.querySelector('div#mark423-playlist a#playlist-item-' + item_id).classList.add('playing');
  recording = mark423Playlist[item_id];
  document.querySelector('div#mark423-player span#mark423-player-speaker').innerHTML = recording.speaker;
  document.querySelector('div#mark423-player span#mark423-player-theme').innerHTML = recording.theme;
  let audio_tag = document.querySelector("audio#mark423-audio")
  audio_tag.src = recording.url
  document.querySelector('div#mark423-player div.jp-eject a').href = recording.url;
  document.querySelector("audio#mark423-audio").currentTime = 0
  mark423_update_progress()
  mark423_pause()
}

function mark423_write_podcast_input(url){
  document.write("<script type='text/javascript' src='" + url + "'></script>");
}

function mark423_apply_translations(){
  document.querySelector('div#mark423-player div.jp-current-speaker span.speaker-label').innerHTML = m4t('speaker');
  document.querySelector('div#mark423-player div.jp-current-theme span.theme-label').innerHTML = m4t('theme');
}

function mark423_update_colors(options){
  background = options['background_color'];
  font_color = options['font_color'];
  highlight = options['highlight_color'];
  font = options['font'];
  document.querySelector('div#mark423-player div.jp-play-bar').style.backgroundColor = highlight;
  document.querySelector('div#mark423-player div.jp-play-pause a.jp-play').style.fill = highlight;
  document.querySelector('div#mark423-player div.jp-play-pause a.jp-pause').style.fill = highlight;
  document.querySelector('div#mark423-player div.jp-display div.jp-current-time').style.color =  highlight;
  document.querySelector('div#mark423-player div.jp-display').style.color = font_color;
  document.querySelector('div#mark423-player div.jp-display').style.backgroundColor = background;
  document.querySelector('div#mark423-player div.jp-play-pause').style.backgroundColor = background;
  document.querySelector('div#mark423-player div.jp-eject ').style.backgroundColor = background;
  document.querySelector('div#mark423-player div.jp-eject a').style.fill = highlight;
  document.querySelector('div#mark423-player div.jp-volume-bar-value').style.backgroundColor = highlight;
  document.querySelector('div#mark423-player div.jp-mute').style.fill = highlight;
  document.querySelector('div#mark423-player div.jp-unmute').style.fill = highlight;
  document.querySelector('div#mark423-playlist').style.backgroundColor = background;
  document.querySelector('div#mark423-playlist').style.font = font;
  document.querySelectorAll('div#mark423-playlist a').forEach(function(playItem) {
    playItem.addEventListener("mouseenter", function() {
      this.style.color = highlight
    });
    playItem.addEventListener("mouseleave", function() {
      this.style.color = font_color
    });
  })
}

function mark423_check_parameters(options){
  if (typeof options['url'] === 'undefined') return alert("No url defined...");
  if (typeof options['highlight_color'] === 'undefined')  options['highlight_color'] = '#DD4B39';
  if (typeof options['font_color'] === 'undefined')  options['font_color'] = '#333333';
  if (typeof options['background_color'] === 'undefined')  options['background_color'] = '#f5f5f5';
  if (typeof options['count'] === 'undefined')  options['count'] = 20;
  if (typeof options['font'] === 'undefined')  options['font'] = '12px Arial';
  
}

function mark423(options){
  console.log("Startup mark423");
  mark423Options = options;
  mark423_check_parameters(options);
  mark423_write_podcast_input(options['url']);
  document.write(mark423Styles);
  document.write(mark423Interface);
  document.addEventListener('DOMContentLoaded', function(){ 
    mark423_install_player();
    mark423_load_podcast(); 
  }, false);
}
console.log('Mark423 player compiled at 2022-11-06 21:37:23 +0100');
